---
import { Icon } from "astro-icon/components";
import info from "@/data";

const navItems = info.navItems;
---

<nav id="floating-nav-desktop" class="floating-nav-desktop">
  <div class="nav-container">
    {
      navItems.map((item, index) => (
        <a href={item.href} class={`nav-item ${index === 0 ? "active" : ""}`} data-section={item.section} {...(item.offset !== undefined ? { "data-offset": item.offset } : {})} aria-label={item.label}>
          <Icon name={item.icon} class="nav-icon" />
          <span class="nav-label">{item.label}</span>
        </a>
      ))
    }
  </div>
</nav>

<style>
  @reference "@/assets/styles/global.css";

  /* Hidden on small screens */
  .floating-nav-desktop {
    display: none;
  }

  @media (min-width: 768px) {
    .floating-nav-desktop {
      @apply pointer-events-none fixed top-1/2 left-6 z-50 block opacity-0;
      transform: translateY(-50%);
      transition: opacity 0.3s ease-in-out;
    }
    .nav-container {
      @apply flex flex-col rounded-xl border p-2;
      gap: 0.25rem;
      background: rgba(2, 21, 38, 0.85);
      backdrop-filter: blur(16px);
      border-color: rgba(224, 230, 237, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .nav-item {
      @apply relative flex cursor-pointer items-center overflow-hidden rounded-lg p-2;
      text-decoration: none;
      color: rgb(var(--foreground-muted));
      transition: all 0.2s ease-in-out;
    }
    .nav-icon {
      @apply h-6 w-6 flex-shrink-0;
      transition: all 0.3s ease-in-out;
    }
    .nav-label {
      @apply overflow-hidden text-sm font-medium whitespace-nowrap opacity-0;
      max-width: 0;
      margin-left: 0;
      transition: all 0.3s ease-in-out;
    }
    .nav-container:hover .nav-label {
      @apply opacity-100;
      max-width: 200px;
      margin-left: 0.375rem;
    }
    .nav-item:hover,
    .nav-item.active {
      color: oklch(var(--accent-text));
      background: oklch(var(--accent-bg) / 0.2);
    }
    .nav-item.active {
      background: oklch(var(--accent-bg) / 0.3);
    }
    .nav-item:hover .nav-icon,
    .nav-item.active .nav-icon {
      color: oklch(var(--accent-text));
    }
    body:has(#hero-loader) .floating-nav-desktop {
      @apply pointer-events-none opacity-0;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const nav = document.getElementById("floating-nav-desktop");
    if (!nav) return;
    const navItems = nav.querySelectorAll(".nav-item");

    function getScrollContainer(el: any) {
      let node = el.parentElement;
      while (node) {
        const style = getComputedStyle(node);
        if (/(auto|scroll)/.test(style.overflowY) && node.scrollHeight > node.clientHeight) return node;
        node = node.parentElement;
      }
      return document.scrollingElement || document.documentElement;
    }

    navItems.forEach((item) => {
      item.addEventListener("click", (e) => {
        e.preventDefault();
        const id = item.getAttribute("href")?.slice(1);
        const target = id ? document.getElementById(id) : null;
        if (!target) return;

        const offsetAttr = item.getAttribute("data-offset");
        const offset = offsetAttr !== null ? Number(offsetAttr) : NaN;
        const container = getScrollContainer(target);

        if (!isNaN(offset)) {
          const containerRect = container.getBoundingClientRect();
          const targetRect = target.getBoundingClientRect();
          const currentScrollTop = container.scrollTop;
          const relativeTop = targetRect.top - containerRect.top;
          const destination = currentScrollTop + relativeTop - offset;
          container.scrollTo({ top: destination, behavior: "smooth" });
        } else {
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });

    const sections = Array.from(navItems)
      .map((item) => document.getElementById(item.getAttribute("href")?.substring(1) || ""))
      .filter(Boolean);

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            navItems.forEach((i) => i.classList.remove("active"));
            const activeItem = Array.from(navItems).find((i) => i.getAttribute("href")?.substring(1) === entry.target.id);
            activeItem?.classList.add("active");
          }
        });
      },
      { root: null, rootMargin: "-20% 0px -60% 0px", threshold: 0 },
    );

    sections.forEach((section: any) => observer.observe(section));

    setTimeout(() => {
      nav.style.opacity = "1";
      nav.style.pointerEvents = "auto";
    }, 2500);
  });
</script>
